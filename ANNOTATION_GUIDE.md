# Подробная инструкция по разметке данных для детекции СИЗ

## Что размечаем

### Класс 0: Защитная каска (helmet) - ОРАНЖЕВАЯ
- Основной цвет для детекции: **оранжевый**
- Разные типы защитных касок
- Разные углы обзора
- Разные условия освещения

### Класс 1: Сигнальный жилет (vest)
- Светоотражающие жилеты
- Сигнальные жилеты разных цветов
- Разные позы людей

## Формат разметки YOLO

### Структура файла

Каждое изображение должно иметь файл разметки с тем же именем и расширением `.txt`.

**Пример:**
- Изображение: `image001.jpg`
- Разметка: `image001.txt`

### Формат строки

Каждая строка в файле разметки описывает один объект:

```
class_id center_x center_y width height
```

**Параметры:**
- `class_id` - номер класса (0 или 1)
- `center_x` - X координата центра (0.0 - 1.0)
- `center_y` - Y координата центра (0.0 - 1.0)
- `width` - ширина bounding box (0.0 - 1.0)
- `height` - высота bounding box (0.0 - 1.0)

**Важно:** Все координаты нормализованы относительно размера изображения (от 0 до 1).

### Пример файла разметки

Файл `image001.txt`:
```
0 0.5 0.3 0.2 0.25
1 0.7 0.6 0.15 0.2
```

Это означает:
- Каска (класс 0) в центре изображения
- Жилет (класс 1) справа внизу

## Как правильно размечать

### Правила для каски (класс 0)

1. **Размечайте всю видимую часть каски:**
   - Включайте козырек, если он виден
   - Включайте ремешок, если он виден
   - Не обрезайте края каски

2. **Если каска частично скрыта:**
   - Размечайте только видимую часть
   - Не пытайтесь "догадаться" о скрытых частях

3. **Bounding box должен:**
   - Плотно обхватывать каску
   - Иметь небольшие отступы (2-5 пикселей)
   - Не включать много фона

### Правила для жилета (класс 1)

1. **Размечайте весь видимый жилет:**
   - Включайте светоотражающие полосы
   - Включайте застежки, если они видны
   - Не обрезайте края жилета

2. **Если жилет частично скрыт:**
   - Размечайте только видимую часть
   - Если видно менее 50% жилета, можно пропустить

3. **Bounding box должен:**
   - Плотно обхватывать жилет
   - Иметь небольшие отступы (2-5 пикселей)
   - Не включать много фона или других объектов

### Общие правила

1. **Точность важнее скорости:**
   - Лучше разметить меньше изображений, но качественно
   - Плохая разметка = плохая модель

2. **Консистентность:**
   - Размечайте одинаковые объекты одинаково
   - Используйте одни и те же правила для всех изображений

3. **Проверка:**
   - После разметки проверьте несколько файлов вручную
   - Убедитесь, что координаты корректны

## Инструменты для разметки

### LabelImg (рекомендуется)

**Установка:**
```bash
pip install labelImg
```

**Запуск:**
```bash
labelImg
```

**Настройка:**
1. Откройте директорию с изображениями: `File -> Open Dir` -> выберите `data/images/train`
2. Выберите формат сохранения: `View -> Auto Save mode` (опционально)
3. **ВАЖНО:** Выберите формат YOLO: `Change Save Dir` -> внизу выберите `YOLO` (не PascalVOC!)
4. Создайте файл классов (опционально):
   - Создайте файл `data/predefined_classes.txt`
   - Добавьте строки:
     ```
     helmet
     vest
     ```
   - В LabelImg: `View -> Use Default Label` -> выберите файл классов

**Использование:**
- `W` - создать bounding box
- `D` - следующее изображение
- `A` - предыдущее изображение
- `Ctrl+S` - сохранить разметку

### Roboflow (онлайн)

1. Зарегистрируйтесь на https://roboflow.com/
2. Создайте новый проект
3. Загрузите изображения
4. Размечайте в браузере
5. Экспортируйте в формате YOLO

### CVAT

Для больших команд и проектов:
- https://github.com/openvinotoolkit/cvat
- Требует установки сервера
- Поддержка формата YOLO

## Проверка разметки

### Автоматическая проверка

Создайте скрипт для проверки:

```python
from pathlib import Path

def check_annotations():
    images_dir = Path("data/images/train")
    labels_dir = Path("data/labels/train")
    
    for img_file in images_dir.glob("*.jpg"):
        label_file = labels_dir / (img_file.stem + ".txt")
        if not label_file.exists():
            print(f"Отсутствует разметка: {img_file.name}")
        
        # Проверка формата
        if label_file.exists():
            with open(label_file) as f:
                for line_num, line in enumerate(f, 1):
                    parts = line.strip().split()
                    if len(parts) != 5:
                        print(f"Ошибка в {label_file.name}, строка {line_num}")
                    try:
                        class_id = int(parts[0])
                        if class_id not in [0, 1]:
                            print(f"Неверный класс в {label_file.name}, строка {line_num}")
                        coords = [float(x) for x in parts[1:]]
                        if any(x < 0 or x > 1 for x in coords):
                            print(f"Координаты вне диапазона в {label_file.name}, строка {line_num}")
                    except ValueError:
                        print(f"Ошибка формата в {label_file.name}, строка {line_num}")

check_annotations()
```

## Частые ошибки

1. **Неправильный формат:**
   - ❌ `0 100 200 50 60` (пиксели вместо нормализованных координат)
   - ✅ `0 0.5 0.3 0.2 0.25` (нормализованные координаты)

2. **Несовпадение имен:**
   - ❌ `image001.jpg` и `image1.txt`
   - ✅ `image001.jpg` и `image001.txt`

3. **Неправильный класс:**
   - ❌ `2 0.5 0.3 0.2 0.25` (класс 2 не существует)
   - ✅ `0` или `1`

4. **Координаты вне диапазона:**
   - ❌ `0 1.5 0.3 0.2 0.25` (center_x > 1.0)
   - ✅ Все координаты от 0.0 до 1.0

5. **Неправильный формат сохранения:**
   - ❌ Сохранение в формате PascalVOC
   - ✅ Сохранение в формате YOLO

## Рекомендации

1. **Начните с малого:**
   - Разметьте 50-100 изображений
   - Обучите модель
   - Проверьте результаты
   - Добавьте больше данных при необходимости

2. **Разнообразие:**
   - Разные углы обзора
   - Разное освещение
   - Разные расстояния
   - Разные фоны

3. **Качество важнее количества:**
   - Лучше 100 качественно размеченных изображений, чем 500 плохих

4. **Проверяйте результаты:**
   - После обучения проверьте детекцию на тестовых изображениях
   - Если модель плохо работает - улучшите разметку

