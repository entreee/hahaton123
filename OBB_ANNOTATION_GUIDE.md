# Руководство по разметке данных для OBB (Rotated Bounding Boxes)

## Формат аннотаций OBB

Модель YOLOv8-OBB требует специальный формат аннотаций для rotated bounding boxes.

### Формат файла аннотации (.txt)

Каждая строка в файле аннотации представляет один объект в формате:

```
class_id x1 y1 x2 y2 x3 y3 x4 y4
```

Где:
- `class_id` - ID класса (0 = helmet, 1 = vest)
- `x1 y1 x2 y2 x3 y3 x4 y4` - 4 точки углов rotated bounding box в нормализованных координатах (0.0 - 1.0)

### Пример аннотации

```
0 0.1 0.2 0.3 0.2 0.3 0.4 0.1 0.4
1 0.5 0.3 0.7 0.3 0.7 0.6 0.5 0.6
```

Это означает:
- Первый объект: класс 0 (helmet) с 4 точками углов
- Второй объект: класс 1 (vest) с 4 точками углов

### Координаты точек

Точки задаются в порядке обхода по часовой стрелке или против часовой стрелки:
- Точка 1: (x1, y1) - первый угол
- Точка 2: (x2, y2) - второй угол
- Точка 3: (x3, y3) - третий угол
- Точка 4: (x4, y4) - четвертый угол

Все координаты нормализованы относительно размера изображения (0.0 - 1.0).

### Инструменты для разметки

Для создания OBB аннотаций можно использовать:

1. **LabelMe** - поддерживает rotated boxes
   - Установка: `pip install labelme`
   - Запуск: `labelme`
   - Экспорт в формат YOLO-OBB

2. **CVAT** - веб-инструмент для разметки
   - Поддерживает rotated bounding boxes
   - Экспорт в формат YOLO-OBB

3. **Roboflow** - онлайн платформа
   - Поддержка OBB аннотаций
   - Автоматическая конвертация форматов

### Конвертация из обычных bounding boxes

Если у вас уже есть обычные bounding boxes (x_center, y_center, width, height), их можно конвертировать в OBB:

```python
def convert_to_obb(x_center, y_center, width, height, angle=0):
    """
    Конвертирует обычный bbox в OBB формат (4 точки).
    
    Args:
        x_center, y_center: центр bbox (нормализованные 0-1)
        width, height: размеры bbox (нормализованные 0-1)
        angle: угол поворота в радианах (опционально)
    
    Returns:
        Список из 4 точек: [x1, y1, x2, y2, x3, y3, x4, y4]
    """
    import numpy as np
    
    # Углы прямоугольника (без поворота)
    w2, h2 = width / 2, height / 2
    corners = np.array([
        [-w2, -h2],  # верхний левый
        [w2, -h2],   # верхний правый
        [w2, h2],    # нижний правый
        [-w2, h2]    # нижний левый
    ])
    
    # Поворот (если нужен)
    if angle != 0:
        cos_a, sin_a = np.cos(angle), np.sin(angle)
        rotation = np.array([[cos_a, -sin_a], [sin_a, cos_a]])
        corners = corners @ rotation.T
    
    # Смещение к центру
    corners[:, 0] += x_center
    corners[:, 1] += y_center
    
    # Нормализация и возврат в виде списка
    return corners.flatten().tolist()
```

### Структура папок

```
data/
├── images/
│   ├── train/
│   │   ├── image1.jpg
│   │   ├── image2.jpg
│   │   └── ...
│   └── val/
│       ├── image1.jpg
│       └── ...
└── labels/
    ├── train/
    │   ├── image1.txt  # OBB аннотации
    │   ├── image2.txt
    │   └── ...
    └── val/
        ├── image1.txt
        └── ...
```

### Проверка аннотаций

Используйте скрипт `visualize_labels.py` для проверки аннотаций:

```bash
python visualize_labels.py --obb  # Для OBB формата
```

### Важные замечания

1. **Порядок точек**: Точки должны быть в правильном порядке (по часовой или против часовой стрелки)
2. **Нормализация**: Все координаты должны быть в диапазоне 0.0 - 1.0
3. **Точность**: Для rotated boxes важна точность разметки углов
4. **Консистентность**: Используйте один и тот же порядок точек для всех объектов

### Пример полной аннотации

Файл `image1.txt`:
```
0 0.15 0.25 0.35 0.25 0.35 0.45 0.15 0.45
1 0.55 0.35 0.75 0.35 0.75 0.65 0.55 0.65
```

Это означает:
- На изображении `image1.jpg` есть 2 объекта
- Первый: helmet (класс 0) с rotated box из 4 точек
- Второй: vest (класс 1) с rotated box из 4 точек

